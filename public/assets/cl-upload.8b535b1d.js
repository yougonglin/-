import{o as e,c as t,z as i,I as s,D as a,aa as l,h as o,ab as r,ac as n,ad as c,ae as d,f as p,Y as u,V as m,j as h,w as g,a as f,t as y,b as F,F as v,d as b,L as S,e as w,v as _,af as k,ag as x,ah as I,i as U}from"./index-93e08a2b.js";import{_ as D}from"./_plugin-vue_export-helper.1b428a4d.js";import{r as L}from"./uni-app.es.4a85af97.js";const T=D({props:{src:{type:String,default:""},cloudType:{type:String,default:"oss"}},data:()=>({imgSrc:""}),mounted(){this.setCloudFunction()},methods:{imgerror(e){this.imgSrc="https://mp-61599c79-d7ee-4a75-a24b-e5a288da6dd3.cdn.bspapp.com/cloudstorage/887c60f0-27f8-46d1-8769-2c45be0f3d7d.png"},setCloudFunction(){const e=this.src.split(".").pop();if(/(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|image)/i.test(e))return this.imgSrc=this.src;switch(this.cloudType){case"oss":this.imgSrc=this.src+"?x-oss-process=video/snapshot,t_0,f_jpg";break;case"process":this.imgSrc=this.src+"?ci-process=snapshot&time=0.01";break;case"vframe":this.imgSrc=this.src+"?vframe/jpg/offset/0";break;default:this.imgSrc=this.src}}}},[["render",function(s,a,l,o,r,n){const c=i;return e(),t(c,{class:"image",src:r.imgSrc,mode:"aspectFill",disabled:!1,controls:!1,onError:n.imgerror},null,8,["src","onError"])}],["__scopeId","data-v-075aee58"]]);const P=D({name:"cl-upload",components:{ClImage:T},props:{modelValue:{type:Array,default:()=>[]},cloudType:{type:String,default:"oss"},fileName:{type:String,default:"file"},fileType:{type:String,default:"all"},imageFormData:{type:Object,default:{}},videoFromData:{type:Object,default:{}},action:{type:String,default:""},cloudPathAsRealPath:{type:Boolean,default:!1},headers:{type:Object,default:()=>{}},data:{type:Object,default:()=>{}},isPreviewImage:{type:Boolean,default:!0},indicator:{type:String,default:"none"},autoUpload:{type:Boolean,default:!0},remove:{type:Boolean,default:!0},add:{type:Boolean,default:!0},max:{type:Number,default:9},maxVideo:{type:Number,default:0},listStyle:{type:Object,default:()=>{}},deleteTitle:{type:String,default:"提示"},deleteText:{type:String,default:"您确认要删除吗？"},loadingText:{type:String,default:"正在上传中..."},useBeforeDelete:{type:Boolean,default:!1},useBeforeUpload:{type:Boolean,default:!1},addImg:{type:String,default:"/static/ui/bb1550b3-e0a8-4a90-a86f-00f8c6afa9fb.png"},playImg:{type:String,default:"/static/ui/ae40402f-aa53-4344-b553-2322799bebd6.png"},deleteImg:{type:String,default:"/static/ui/d20177a5-417e-4c5d-a266-1988361c543d.png"},closeImg:{type:String,default:"/static/ui/cde4362d-7ec7-4cac-a692-12e1f576be1e.png"}},data:()=>({FileList:[],tempVideoUrl:"",tempFile_paths:[]}),watch:{modelValue:{handler:function(e,t){this.FileList=e},deep:!0,immediate:!0}},computed:{previewList(){return this.FileList.map((e=>({path:e.path||e,poster:e.poster||""})))},listRowStyle(){var e,t,i,s;return{"grid-template-columns":`repeat(${(null==(e=this.listStyle)?void 0:e.columns)||4}, 1fr)`,"grid-column-gap":(null==(t=this.listStyle)?void 0:t.columnGap)||"40rpx","grid-row-gap":(null==(i=this.listStyle)?void 0:i.rowGap)||"40rpx",padding:(null==(s=this.listStyle)?void 0:s.padding)||"0rpx"}},rowStyle(){const{height:e="218rpx",ratio:t}=this.listStyle||{};return{"aspect-ratio":e?"":t||"1/1",height:e}},imgStyle(){var e;return{"border-radius":(null==(e=this.listStyle)?void 0:e.radius)||"6rpx"}}},methods:{deleteSelectedFile(e,t){const i=this.FileList[t];this.useBeforeDelete&&this.$emit("beforeDelete",i,t,(()=>a())),this.useBeforeDelete||s({title:this.deleteTitle,content:this.deleteText,success:e=>{e.confirm&&a()}});const a=()=>{const i=this.tempFile_paths.indexOf(e||e.path);i>-1&&this.tempFile_paths.splice(i,1),this.FileList.splice(t,1),this.$emit("update:modelValue",this.FileList)}},clickSelectedFile(e,t){this.previewImage((null==e?void 0:e.path)??e,t),this.$emit("onImage",{item:e,index:t})},selectFileTypeOnAdd(){switch(console.log(21645645),this.fileType){case"image":default:this.handleFileSelection(1);break;case"video":this.handleFileSelection(2);break;case"all":a({itemList:["相册","视频"],success:e=>{0===e.tapIndex?this.handleFileSelection(1):this.handleFileSelection(2)},fail:e=>{console.error(e.errMsg)}})}},async handleFileSelection(e){const t=this;if(1===e){const e=Object.assign({},{count:9,sizeType:["original","compressed"],sourceType:["camera","album"],compress:!1},this.imageFormData);e.count=this.max-this.FileList.length,l({...e,success:async e=>{var i,s;let a=e.tempFiles;const l=(null==(i=t.imageFormData)?void 0:i.compress)||!1;if(null==(s=t.imageFormData)?void 0:s.size){const e=1024*t.imageFormData.size*1024;a.map(((i,s)=>{if(i.size>e)return a.splice(s,1),t.$emit("onImageSize",i),o({title:`图片最大上传${t.imageFormData.size}MB`,duration:2e3,icon:"none"})}))}if(l){const e=a.map((e=>t.compressImage(e.path)));Promise.all(e).then((e=>{r(e)}))}else r(a);function r(e){t.autoUpload?e.map((e=>{t.onBeforeUploadFile(e,"image")})):(t.FileList=[...t.FileList,...e],e.map((e=>{t.tempFile_paths.push(e)})))}},fail(e){console.error("选择图片失败",e),t.$emit("onError",e)}})}if(2===e){const e=/\.(mp4|flv|avi)/i,i=await t.FileList.filter((t=>{const i=(null==t?void 0:t.url)??t;return e.test(i)}));if(t.maxVideo>0&&i.length>=t.maxVideo)return t.$emit("onVideoMax",t.maxVideo,i.length),o({title:"视频数量已超出",duration:2e3,icon:"none"});const s=Object.assign({},{maxDuration:60,camera:"back",sourceType:["camera","album"],compressed:!0},this.videoFromData);r({...s,success:e=>{var i;let s={...e};if(s.path=e.tempFilePath,null==(i=t.videoFromData)?void 0:i.size){const e=1024*t.videoFromData.size*1024;if(s.size>e)return o({title:`视频最大上传${t.videoFromData.size}MB`,duration:2e3,icon:"none"}),!1}t.autoUpload?t.onBeforeUploadFile(s,"video"):(t.FileList.push(s),t.tempFile_paths.push(s))},fail(e){console.error("选择视频失败",e)}})}},onBeforeUploadFile(e){return this.useBeforeUpload?this.$emit("beforeUpload",e,(()=>this.updataFile(e))):this.updataFile(e)},updataFile(e){const t=this,i=e.path||e,s="image"==this.fileUrlType(i)?".png":".mp4",a=e.name||Date.now()+s;return n({title:this.loadingText,icon:"loading"}),new Promise(((s,l)=>{if("uniCloud"===t.action)return c.uploadFile({cloudPath:String(a),filePath:i,cloudPathAsRealPath:this.cloudPathAsRealPath,onUploadProgress:e=>{const i=Math.round(100*e.loaded/e.total);t.$emit("onProgress",i)},success(e){t.autoUpload?t.FileList.push(e.fileID):t.FileList.map(((s,a)=>{s!==i&&s.path!==i||t.FileList.splice(a,1,e.fileID)})),t.$emit("update:modelValue",t.FileList),s(e.fileID),d(),t.$emit("onProgress",{...e})},fail:e=>{d(),console.error("error",e),t.$emit("onError",e),l(e)}}),!1;const o=p("loginToken"),r=p("admin-supernova-token");u({url:t.action,filePath:i,name:t.fileName,formData:t.data,header:{"supernova-token":o,"admin-supernova-token":r,...t.headers},success:e=>{const a=JSON.parse(e.data);d(),t.success(a),this.autoUpload||t.FileList.map(((e,s)=>{e!==i&&e.path!==i||t.FileList.splice(s,1)})),s(a)},fail:e=>{d(),console.error("error",e),t.$emit("onError",e),l(e)}}).onProgressUpdate((i=>{t.$emit("onProgress",{...i,...e})}))}))},submit(){return new Promise(((e,t)=>{this.tempFile_paths.length<=0&&e([]);const i=this.tempFile_paths.map((e=>this.onBeforeUploadFile(e||e.path)));Promise.all(i).then((t=>{this.tempFile_paths=[],e(t)})).catch((e=>{t(e)}))}))},success(e){this.$emit("onSuccess",e)},async compressImage(e){const t=this;return new Promise(((i,s)=>{"string"!=typeof e&&(console.error("压缩路径错误"),s([])),n({title:"压缩中...",icon:"loading"}),this.canvasDataURL(e,{quality:t.imageFormData.quality/100},(e=>{i(e),d()}))}))},canvasDataURL(e,t,i){var s=new Image;s.src=e,s.onload=function(){var e=this,s=e.width,a=e.height,l=s/a;s=t.width||s,a=t.height||s/l;var o=.8,r=document.createElement("canvas"),n=r.getContext("2d"),c=document.createAttribute("width");c.nodeValue=s;var d=document.createAttribute("height");d.nodeValue=a,r.setAttributeNode(c),r.setAttributeNode(d),n.drawImage(e,0,0,s,a),t.quality&&t.quality<=1&&t.quality>0&&(o=t.quality);var p=r.toDataURL("image/png",o);i(p)}},previewImage(e){if("video"===this.fileUrlType(e))return!1;if(!this.isPreviewImage)return!1;const t=this.FileList.filter((e=>"video"!==this.fileUrlType(e))).map((e=>(null==e?void 0:e.path)??e)),i=t.indexOf(e||e.path);m({current:i,urls:t,success(){},fail(e){console.log(e)}})},previewVideo(e,t){this.$emit("onVideo",{item:e,index:t}),this.tempVideoUrl=e.path},fileUrlType(e){const t=e.path||e;if(this.isBase64(t))return"image";const i=t.split(".").pop();return/(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|image)/i.test(i)?"image":"video"},isBase64:e=>""===e||"string"!=typeof e?console.error("文件路径错误, base64",e):e.includes("blob:")||e.includes("data:image")}},[["render",function(s,a,l,o,r,n){const c=i,d=k,p=x,u=I,m=L(h("cl-image"),T),D=U;return e(),t(D,{class:"cl-updata"},{default:g((()=>[f(D,{class:"file-list",style:y([n.listRowStyle])},{default:g((()=>[(e(!0),F(v,null,b(n.previewList,((i,s)=>(e(),t(D,{onClick:e=>n.clickSelectedFile(i,s),class:"file-list-row",style:y([n.rowStyle]),key:s},{default:g((()=>["image"===n.fileUrlType(i)?(e(),t(c,{key:0,class:"_image",src:i.path,style:y([n.imgStyle]),mode:"aspectFill"},null,8,["src","style"])):(e(),t(D,{key:1,class:"_video",style:y([n.imgStyle])},{default:g((()=>["other"===l.cloudType?(e(),t(u,{key:0,class:"_video",autoplay:!1,style:y([n.imgStyle]),src:i.path,controls:!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"show-play-btn":!1,"show-loading":!1,"enable-progress-gesture":!1},{default:g((()=>[f(p,{onClick:e=>n.previewVideo(i,s),class:"play"},{default:g((()=>[f(d,{style:{width:"100%"},src:l.playImg,mode:"widthFix"},null,8,["src"])])),_:2},1032,["onClick"])])),_:2},1032,["style","src"])):(e(),F(v,{key:1},[f(m,{class:"pay",style:y([n.imgStyle]),cloudType:l.cloudType,src:i.poster||i.path},null,8,["style","cloudType","src"]),f(D,{class:"play",onClick:e=>n.previewVideo(i,s)},{default:g((()=>[f(c,{class:"play-img",src:l.playImg,mode:"widthFix"},null,8,["src"])])),_:2},1032,["onClick"])],64))])),_:2},1032,["style"])),l.remove?(e(),t(D,{key:2,class:"remove",onClick:S((e=>n.deleteSelectedFile(i,s)),["stop"])},{default:g((()=>[f(c,{class:"image",src:l.deleteImg,mode:"widthFix"},null,8,["src"])])),_:2},1032,["onClick"])):w("",!0)])),_:2},1032,["onClick","style"])))),128)),l.add&&r.FileList.length<l.max?(e(),t(D,{key:0,style:y([n.rowStyle]),class:"file-list-row"},{default:g((()=>[_(s.$slots,"addImg",{},(()=>[f(D,{class:"add-image",onClick:n.selectFileTypeOnAdd},{default:g((()=>[f(c,{class:"_image",src:l.addImg,mode:"widthFix"},null,8,["src"])])),_:1},8,["onClick"])]),!0)])),_:3},8,["style"])):w("",!0)])),_:3},8,["style"]),r.tempVideoUrl?(e(),t(D,{key:0,class:"mask"},{default:g((()=>[f(c,{onClick:a[0]||(a[0]=e=>r.tempVideoUrl=""),class:"_root",src:l.closeImg,mode:"widthFix"},null,8,["src"]),f(D,{class:"block",onClick:a[1]||(a[1]=S((()=>{}),["stop"]))},{default:g((()=>[f(u,{class:"block_video",autoplay:"",src:r.tempVideoUrl},null,8,["src"])])),_:1})])),_:1})):w("",!0)])),_:3})}],["__scopeId","data-v-ca734f2b"]]);export{P as _};
